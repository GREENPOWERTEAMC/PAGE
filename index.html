<?php
  $page_title = 'Editar videojuego';
  require_once('includes/load.php');
  // Verificar el nivel de permiso del usuario para ver esta página
  page_require_level(2);
?>

<?php
  // Verificar si se ha proporcionado el parámetro "id"
  if (isset($_GET['id'])) {
    $videojuego = find_by_id('videojuego', (int)$_GET['id']);
    if (!$videojuego) {
      $session->msg("d", "ID vacío");
      redirect('product.php');
    }
  } else {
    $session->msg("d", "ID no encontrado");
    redirect('product.php');
  }
?>

<?php
  if(isset($_POST['videojuego'])){
    $req_fields = array('nombre', 'personaje', 'creador', 'desarrolladora', 'plataforma', 'genero', 'precio', 'clasificacion');
    validate_fields($req_fields);

    if(empty($errors)){
      $p_name  = remove_junk($db->escape($_POST['nombre']));
      $p_personaje = remove_junk($db->escape($_POST['personaje']));
      $p_creador = remove_junk($db->escape($_POST['creador']));
      $p_desarrolladora = remove_junk($db->escape($_POST['desarrolladora']));
      $p_plataforma = remove_junk($db->escape($_POST['plataforma']));
      $p_genero = remove_junk($db->escape($_POST['genero']));
      $p_precio = remove_junk($db->escape($_POST['precio']));
      $p_clasificacion = remove_junk($db->escape($_POST['clasificacion']));

      $query = "UPDATE videojuego SET";
      $query .= " nombre ='{$p_name}', personaje_id ='{$p_personaje}', creador_id ='{$p_creador}', desarrolladora_id ='{$p_desarrolladora}',";
      $query .= " plataforma_id ='{$p_plataforma}', genero_id ='{$p_genero}', precio ='{$p_precio}', clasificacion ='{$p_clasificacion}'";
      $query .= " WHERE id ='{$videojuego['id']}'";
      $result = $db->query($query);

      if($result && $db->affected_rows() === 1){
        $session->msg('s', "El videojuego ha sido actualizado.");
        redirect('product.php', false);
      } else {
        $session->msg('d', 'Lo siento, la actualización falló.');
        redirect('edit_product.php?id='.$videojuego['id'], false);
      }
    } else {
      $session->msg("d", $errors);
      redirect('edit_product.php?id='.$videojuego['id'], false);
    }
  }
?>

<?php include_once('layouts/header.php'); ?>
<div class="row">
  <div class="col-md-12">
    <?php echo display_msg($msg); ?>
  </div>
</div>
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <strong>
          <span class="glyphicon glyphicon-th"></span>
          Actualizar videojuego
        </strong>
      </div>
      <div class="panel-body">
        <form method="post" action="edit_product.php?id=<?php echo (int)$videojuego['id']; ?>">
          <div class="form-group">
            <label for="nombre">Nombre</label>
            <input type="text" class="form-control" name="nombre" value="<?php echo isset($videojuego['nombre']) ? remove_junk($videojuego['nombre']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="personaje">Personaje</label>
            <input type="text" class="form-control" name="personaje" value="<?php echo isset($videojuego['nombre_personaje']) ? remove_junk($videojuego['nombre_personaje']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="creador">Creador</label>
            <input type="text" class="form-control" name="creador" value="<?php echo isset($videojuego['nombre_creador']) ? remove_junk($videojuego['nombre_creador']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="desarrolladora">Desarrolladora</label>
            <input type="text" class="form-control" name="desarrolladora" value="<?php echo isset($videojuego['nombre_desarrolladora']) ? remove_junk($videojuego['nombre_desarrolladora']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="plataforma">Plataforma</label>
            <input type="text" class="form-control" name="plataforma" value="<?php echo isset($videojuego['nombre_plataforma']) ? remove_junk($videojuego['nombre_plataforma']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="genero">Género</label>
            <input type="text" class="form-control" name="genero" value="<?php echo isset($videojuego['nombre_genero']) ? remove_junk($videojuego['nombre_genero']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="precio">Precio</label>
            <input type="text" class="form-control" name="precio" value="<?php echo isset($videojuego['precio']) ? remove_junk($videojuego['precio']) : ''; ?>">
          </div>
          <div class="form-group">
            <label for="clasificacion">Clasificación</label>
            <input type="text" class="form-control" name="clasificacion" value="<?php echo isset($videojuego['clasificacion']) ? remove_junk($videojuego['clasificacion']) : ''; ?>">
          </div>
          <button type="submit" name="videojuego" class="btn btn-primary">Actualizar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<?php include_once('layouts/footer.php'); ?>
